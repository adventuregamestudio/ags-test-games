// Test Interactions Module Script
#define CHARACTER_INTERACTION_TEST_CASES (3*8)
#define INVITEM_INTERACTION_TEST_CASES (2*8)
#define OBJECT_INTERACTION_TEST_CASES (3*8)
#define HOTSPOT_INTERACTION_TEST_CASES (3*8)
#define REGION_INTERACTION_TEST_CASES (3)
int GetTestInteractionsCount()
{
  return 0
    + CHARACTER_INTERACTION_TEST_CASES * 3
    + INVITEM_INTERACTION_TEST_CASES * 3
    + OBJECT_INTERACTION_TEST_CASES * 3
    + HOTSPOT_INTERACTION_TEST_CASES * 3
    + REGION_INTERACTION_TEST_CASES
  ;
}

String InteractionTest_Name;
String InteractionTest_HandlerCheck;
String InteractionTest_AnyClickCheck;
String InteractionTest_UnhandledCheck;

void TestInter_Setup(String test_name, String handler_check, String anyclick_check, String unhandled_check)
{
  LastInteraction = "";
  LastAnyClickInteraction = "";
  LastUnhandledEvent = "";
  
  InteractionTest_Name = test_name;
  InteractionTest_HandlerCheck = handler_check;
  InteractionTest_AnyClickCheck = anyclick_check;
  InteractionTest_UnhandledCheck = unhandled_check;
}

void TestCharInter_Run(Character *c, String test_name, CursorMode mode, String handler_check, String anyclick_check, String unhandled_check)
{
  TestInter_Setup(test_name, handler_check, anyclick_check, unhandled_check);
  c.RunInteraction(mode);
}

void TestInvItemInter_Run(InventoryItem *i, String test_name, CursorMode mode, String handler_check, String anyclick_check, String unhandled_check)
{
  TestInter_Setup(test_name, handler_check, anyclick_check, unhandled_check);
  i.RunInteraction(mode);
}

void TestObjectInter_Run(Object *o, String test_name, CursorMode mode, String handler_check, String anyclick_check, String unhandled_check)
{
  TestInter_Setup(test_name, handler_check, anyclick_check, unhandled_check);
  o.RunInteraction(mode);
}

void TestHotspotInter_Run(Hotspot *h, String test_name, CursorMode mode, String handler_check, String anyclick_check, String unhandled_check)
{
  TestInter_Setup(test_name, handler_check, anyclick_check, unhandled_check);
  h.RunInteraction(mode);
}

void TestRegionEvent_Run(Region *r, String test_name, int mode, String handler_check)
{
  TestInter_Setup(test_name, handler_check, null, null);
  r.RunInteraction(mode);
}

void TestInter_Check()
{
  String test_name = InteractionTest_Name;
  String handler_check = InteractionTest_HandlerCheck;
  String anyclick_check = InteractionTest_AnyClickCheck;
  String unhandled_check = InteractionTest_UnhandledCheck;
  
  if (String.IsNullOrEmpty(handler_check))
    tap.is(LastInteraction, handler_check, String.Format("%s No Handler", test_name));
  else
    tap.is(LastInteraction, handler_check, String.Format("%s Run Handler", test_name));

  if (String.IsNullOrEmpty(anyclick_check))
    tap.is(LastAnyClickInteraction, anyclick_check, String.Format("%s No AnyClick Handler", test_name));
  else
    tap.is(LastAnyClickInteraction, anyclick_check, String.Format("%s Run AnyClick Handler", test_name));

  if (String.IsNullOrEmpty(unhandled_check))
    tap.is(LastUnhandledEvent, unhandled_check, String.Format("%s No Unhandled Event", test_name));
  else
    tap.is(LastUnhandledEvent, unhandled_check, String.Format("%s Run Unhandled Event", test_name));
}

void TestEvent_Check()
{
  String test_name = InteractionTest_Name;
  String handler_check = InteractionTest_HandlerCheck;
  
  if (String.IsNullOrEmpty(handler_check))
    tap.is(LastInteraction, handler_check, String.Format("%s No Handler", test_name));
  else
    tap.is(LastInteraction, handler_check, String.Format("%s Run Handler", test_name));
}

void TestCharacterInteractions(int counter)
{
  bool is_run_case = ((counter % 2) == 0);
  if (is_run_case)
  {
    counter = counter / 2;
    switch (counter)
    {
    // Interactable character
    case 0:  TestCharInter_Run(cInteractive, "Character.RunInteraction: Lookat", eModeLookat,  "Character.Lookat", "Character.AnyClick", null); break;
    case 1:  TestCharInter_Run(cInteractive, "Character.RunInteraction: Interact", eModeInteract, "Character.Interact", "Character.AnyClick", null); break;
    case 2:  TestCharInter_Run(cInteractive, "Character.RunInteraction: Talkto", eModeTalkto, "Character.Talkto", "Character.AnyClick", null); break;
    case 3:  TestCharInter_Run(cInteractive, "Character.RunInteraction: Useinv", eModeUseinv, "Character.Useinv", "Character.AnyClick", null); break;
    case 4:  TestCharInter_Run(cInteractive, "Character.RunInteraction: Pickup", eModePickup, "Character.Pickup", "Character.AnyClick", null); break;
    case 5:  TestCharInter_Run(cInteractive, "Character.RunInteraction: Pointer", eModePointer, null, "Character.AnyClick", null); break;
    case 6:  TestCharInter_Run(cInteractive, "Character.RunInteraction: Mode8", eModeUsermode1, "Character.Mode8", "Character.AnyClick", null); break;
    case 7:  TestCharInter_Run(cInteractive, "Character.RunInteraction: Mode9", eModeUsermode2, "Character.Mode9", "Character.AnyClick", null); break;
    // Character with only AnyClick
    case 8:  TestCharInter_Run(cAnyClicker, "Character.RunInteraction: Lookat (anyclick)", eModeLookat, null, "Character.AnyClick", null); break;
    case 9:  TestCharInter_Run(cAnyClicker, "Character.RunInteraction: Interact (anyclick)", eModeInteract, null, "Character.AnyClick", null); break;
    case 10: TestCharInter_Run(cAnyClicker, "Character.RunInteraction: Talkto (anyclick)", eModeTalkto, null, "Character.AnyClick", null); break;
    case 11: TestCharInter_Run(cAnyClicker, "Character.RunInteraction: Useinv (anyclick)", eModeUseinv, null, "Character.AnyClick", null); break;
    case 12: TestCharInter_Run(cAnyClicker, "Character.RunInteraction: Pickup (anyclick)", eModePickup, null, "Character.AnyClick", null); break;
    case 13: TestCharInter_Run(cAnyClicker, "Character.RunInteraction: Pointer (anyclick)", eModePointer, null, "Character.AnyClick", null); break;
    case 14: TestCharInter_Run(cAnyClicker, "Character.RunInteraction: Mode8 (anyclick)", eModeUsermode1, null, "Character.AnyClick", null); break;
    case 15: TestCharInter_Run(cAnyClicker, "Character.RunInteraction: Mode9 (anyclick)", eModeUsermode2, null, "Character.AnyClick", null); break;
    // Character w/o handlers
    case 16: TestCharInter_Run(cNoHandlers, "Character.RunInteraction: Lookat (none)", eModeLookat, null, null, "Character.Unhandled.Lookat"); break;
    case 17: TestCharInter_Run(cNoHandlers, "Character.RunInteraction: Interact (none)", eModeInteract, null, null, "Character.Unhandled.Interact"); break;
    case 18: TestCharInter_Run(cNoHandlers, "Character.RunInteraction: Talkto (none)", eModeTalkto, null, null, "Character.Unhandled.Talkto"); break;
    case 19: TestCharInter_Run(cNoHandlers, "Character.RunInteraction: Useinv (none)", eModeUseinv, null, null, "Character.Unhandled.Useinv"); break;
    case 20: TestCharInter_Run(cNoHandlers, "Character.RunInteraction: Pickup (none)", eModePickup, null, null, "Character.Unhandled.Pickup"); break;
    case 21: TestCharInter_Run(cNoHandlers, "Character.RunInteraction: Pointer (none)", eModePointer, null, null, null); break;
    case 22: TestCharInter_Run(cNoHandlers, "Character.RunInteraction: Mode8 (none)", eModeUsermode1, null, null, "Character.Unhandled.Mode8"); break;
    case 23: TestCharInter_Run(cNoHandlers, "Character.RunInteraction: Mode9 (none)", eModeUsermode2, null, null, "Character.Unhandled.Mode9"); break;
    }
  }
  else
  {
    TestInter_Check();
  }
}

void TestInventoryInteractions(int counter)
{
  bool is_run_case = ((counter % 2) == 0);
  if (is_run_case)
  {
    counter = counter / 2;
    switch (counter)
    {
    // Interactable inventory
    case 0:  TestInvItemInter_Run(iInteractive, "InvItem.RunInteraction: Lookat", eModeLookat,  "InvItem.Lookat", null, null); break;
    case 1:  TestInvItemInter_Run(iInteractive, "InvItem.RunInteraction: Interact", eModeInteract, "InvItem.Interact", null, null); break;
    case 2:  TestInvItemInter_Run(iInteractive, "InvItem.RunInteraction: Talkto", eModeTalkto, "InvItem.Talkto", null, null); break;
    case 3:  TestInvItemInter_Run(iInteractive, "InvItem.RunInteraction: Useinv", eModeUseinv, "InvItem.Useinv", null, null); break;
    case 4:  TestInvItemInter_Run(iInteractive, "InvItem.RunInteraction: Pickup", eModePickup, "InvItem.OtherClick", null, null); break;
    case 5:  TestInvItemInter_Run(iInteractive, "InvItem.RunInteraction: Pointer", eModePointer, null, null, null); break;
    case 6:  TestInvItemInter_Run(iInteractive, "InvItem.RunInteraction: Mode8", eModeUsermode1, "InvItem.OtherClick", null, null); break;
    case 7:  TestInvItemInter_Run(iInteractive, "InvItem.RunInteraction: Mode9", eModeUsermode2, "InvItem.OtherClick", null, null); break;
    // NOTE: in AGS 3.* Inventory items do not have AnyClick
    
    // Inventory w/o handlers
    case 8:  TestInvItemInter_Run(iNoHandlers, "InvItem.RunInteraction: Lookat (none)", eModeLookat, null, null, "InvItem.Unhandled.Lookat"); break;
    case 9:  TestInvItemInter_Run(iNoHandlers, "InvItem.RunInteraction: Interact (none)", eModeInteract, null, null, "InvItem.Unhandled.Interact"); break;
    case 10: TestInvItemInter_Run(iNoHandlers, "InvItem.RunInteraction: Talkto (none)", eModeTalkto, null, null, "InvItem.Unhandled.Talkto"); break;
    case 11: TestInvItemInter_Run(iNoHandlers, "InvItem.RunInteraction: Useinv (none)", eModeUseinv, null, null, "InvItem.Unhandled.Useinv"); break;
    case 12: TestInvItemInter_Run(iNoHandlers, "InvItem.RunInteraction: Pickup  (none)", eModePickup, null, null, "InvItem.Unhandled.OtherClick"); break;
    case 13: TestInvItemInter_Run(iNoHandlers, "InvItem.RunInteraction: Pointer (none)", eModePointer, null, null, null); break;
    case 14: TestInvItemInter_Run(iNoHandlers, "InvItem.RunInteraction: Mode8 (none)", eModeUsermode1, null, null, "InvItem.Unhandled.OtherClick"); break;
    case 15: TestInvItemInter_Run(iNoHandlers, "InvItem.RunInteraction: Mode9 (none)", eModeUsermode2, null, null, "InvItem.Unhandled.OtherClick"); break;
    }
  }
  else
  {
    TestInter_Check();
  }
}

void TestObjectInteractions(int counter)
{
  bool is_run_case = ((counter % 2) == 0);
  if (is_run_case)
  {
    Object *oInteractive = Object.GetByName("oInteractive");
    Object *oAnyClicker = Object.GetByName("oAnyClicker");
    Object *oNoHandlers = Object.GetByName("oNoHandlers");
    
    counter = counter / 2;
    switch (counter)
    {
    // Interactable Object
    case 0:  TestObjectInter_Run(oInteractive, "Object.RunInteraction: Lookat", eModeLookat,  "Object.Lookat", "Object.AnyClick", null); break;
    case 1:  TestObjectInter_Run(oInteractive, "Object.RunInteraction: Interact", eModeInteract, "Object.Interact", "Object.AnyClick", null); break;
    case 2:  TestObjectInter_Run(oInteractive, "Object.RunInteraction: Talkto", eModeTalkto, "Object.Talkto", "Object.AnyClick", null); break;
    case 3:  TestObjectInter_Run(oInteractive, "Object.RunInteraction: Useinv", eModeUseinv, "Object.Useinv", "Object.AnyClick", null); break;
    case 4:  TestObjectInter_Run(oInteractive, "Object.RunInteraction: Pickup", eModePickup, "Object.Pickup", "Object.AnyClick", null); break;
    case 5:  TestObjectInter_Run(oInteractive, "Object.RunInteraction: Pointer", eModePointer, null, "Object.AnyClick", null); break;
    case 6:  TestObjectInter_Run(oInteractive, "Object.RunInteraction: Mode8", eModeUsermode1, "Object.Mode8", "Object.AnyClick", null); break;
    case 7:  TestObjectInter_Run(oInteractive, "Object.RunInteraction: Mode9", eModeUsermode2, "Object.Mode9", "Object.AnyClick", null); break;
    // Object with only AnyClick
    case 8:  TestObjectInter_Run(oAnyClicker, "Object.RunInteraction: Lookat (anyclick)", eModeLookat, null, "Object.AnyClick", null); break;
    case 9:  TestObjectInter_Run(oAnyClicker, "Object.RunInteraction: Interact (anyclick)", eModeInteract, null, "Object.AnyClick", null); break;
    case 10: TestObjectInter_Run(oAnyClicker, "Object.RunInteraction: Talkto (anyclick)", eModeTalkto, null, "Object.AnyClick", null); break;
    case 11: TestObjectInter_Run(oAnyClicker, "Object.RunInteraction: Useinv (anyclick)", eModeUseinv, null, "Object.AnyClick", null); break;
    case 12: TestObjectInter_Run(oAnyClicker, "Object.RunInteraction: Pickup (anyclick)", eModePickup, null, "Object.AnyClick", null); break;
    case 13: TestObjectInter_Run(oAnyClicker, "Object.RunInteraction: Pointer (anyclick)", eModePointer, null, "Object.AnyClick", null); break;
    case 14: TestObjectInter_Run(oAnyClicker, "Object.RunInteraction: Mode8 (anyclick)", eModeUsermode1, null, "Object.AnyClick", null); break;
    case 15: TestObjectInter_Run(oAnyClicker, "Object.RunInteraction: Mode9 (anyclick)", eModeUsermode2, null, "Object.AnyClick", null); break;
    // Object w/o handlers
    case 16: TestObjectInter_Run(oNoHandlers, "Object.RunInteraction: Lookat (none)", eModeLookat, null, null, "Object.Unhandled.Lookat"); break;
    case 17: TestObjectInter_Run(oNoHandlers, "Object.RunInteraction: Interact (none)", eModeInteract, null, null, "Object.Unhandled.Interact"); break;
    case 18: TestObjectInter_Run(oNoHandlers, "Object.RunInteraction: Talkto (none)", eModeTalkto, null, null, "Object.Unhandled.Talkto"); break;
    case 19: TestObjectInter_Run(oNoHandlers, "Object.RunInteraction: Useinv (none)", eModeUseinv, null, null, "Object.Unhandled.Useinv"); break;
    case 20: TestObjectInter_Run(oNoHandlers, "Object.RunInteraction: Pickup (none)", eModePickup, null, null, "Object.Unhandled.Pickup"); break;
    case 21: TestObjectInter_Run(oNoHandlers, "Object.RunInteraction: Pointer (none)", eModePointer, null, null, null); break;
    case 22: TestObjectInter_Run(oNoHandlers, "Object.RunInteraction: Mode8 (none)", eModeUsermode1, null, null, "Object.Unhandled.Mode8"); break;
    case 23: TestObjectInter_Run(oNoHandlers, "Object.RunInteraction: Mode9 (none)", eModeUsermode2, null, null, "Object.Unhandled.Mode9"); break;
    }
  }
  else
  {
    TestInter_Check();
  }
}

void TestHotspotInteractions(int counter)
{
  bool is_run_case = ((counter % 2) == 0);
  if (is_run_case)
  {
    Hotspot *hInteractive = Hotspot.GetByName("hInteractive");
    Hotspot *hAnyClicker = Hotspot.GetByName("hAnyClicker");
    Hotspot *hNoHandlers = Hotspot.GetByName("hNoHandlers");
    
    counter = counter / 2;
    switch (counter)
    {
    // Interactable Hotspot
    case 0:  TestHotspotInter_Run(hInteractive, "Hotspot.RunInteraction: Lookat", eModeLookat,  "Hotspot.Lookat", "Hotspot.AnyClick", null); break;
    case 1:  TestHotspotInter_Run(hInteractive, "Hotspot.RunInteraction: Interact", eModeInteract, "Hotspot.Interact", "Hotspot.AnyClick", null); break;
    case 2:  TestHotspotInter_Run(hInteractive, "Hotspot.RunInteraction: Talkto", eModeTalkto, "Hotspot.Talkto", "Hotspot.AnyClick", null); break;
    case 3:  TestHotspotInter_Run(hInteractive, "Hotspot.RunInteraction: Useinv", eModeUseinv, "Hotspot.Useinv", "Hotspot.AnyClick", null); break;
    case 4:  TestHotspotInter_Run(hInteractive, "Hotspot.RunInteraction: Pickup", eModePickup, "Hotspot.Pickup", "Hotspot.AnyClick", null); break;
    case 5:  TestHotspotInter_Run(hInteractive, "Hotspot.RunInteraction: Pointer", eModePointer, null, "Hotspot.AnyClick", null); break;
    case 6:  TestHotspotInter_Run(hInteractive, "Hotspot.RunInteraction: Mode8", eModeUsermode1, "Hotspot.Mode8", "Hotspot.AnyClick", null); break;
    case 7:  TestHotspotInter_Run(hInteractive, "Hotspot.RunInteraction: Mode9", eModeUsermode2, "Hotspot.Mode9", "Hotspot.AnyClick", null); break;
    // Hotspot with only AnyClick
    case 8:  TestHotspotInter_Run(hAnyClicker, "Hotspot.RunInteraction: Lookat (anyclick)", eModeLookat, null, "Hotspot.AnyClick", null); break;
    case 9:  TestHotspotInter_Run(hAnyClicker, "Hotspot.RunInteraction: Interact (anyclick)", eModeInteract, null, "Hotspot.AnyClick", null); break;
    case 10: TestHotspotInter_Run(hAnyClicker, "Hotspot.RunInteraction: Talkto (anyclick)", eModeTalkto, null, "Hotspot.AnyClick", null); break;
    case 11: TestHotspotInter_Run(hAnyClicker, "Hotspot.RunInteraction: Useinv (anyclick)", eModeUseinv, null, "Hotspot.AnyClick", null); break;
    case 12: TestHotspotInter_Run(hAnyClicker, "Hotspot.RunInteraction: Pickup (anyclick)", eModePickup, null, "Hotspot.AnyClick", null); break;
    case 13: TestHotspotInter_Run(hAnyClicker, "Hotspot.RunInteraction: Pointer (anyclick)", eModePointer, null, "Hotspot.AnyClick", null); break;
    case 14: TestHotspotInter_Run(hAnyClicker, "Hotspot.RunInteraction: Mode8 (anyclick)", eModeUsermode1, null, "Hotspot.AnyClick", null); break;
    case 15: TestHotspotInter_Run(hAnyClicker, "Hotspot.RunInteraction: Mode9 (anyclick)", eModeUsermode2, null, "Hotspot.AnyClick", null); break;
    // Hotspot w/o handlers
    case 16: TestHotspotInter_Run(hNoHandlers, "Hotspot.RunInteraction: Lookat (none)", eModeLookat, null, null, "Hotspot.Unhandled.Lookat"); break;
    case 17: TestHotspotInter_Run(hNoHandlers, "Hotspot.RunInteraction: Interact (none)", eModeInteract, null, null, "Hotspot.Unhandled.Interact"); break;
    case 18: TestHotspotInter_Run(hNoHandlers, "Hotspot.RunInteraction: Talkto (none)", eModeTalkto, null, null, "Hotspot.Unhandled.Talkto"); break;
    case 19: TestHotspotInter_Run(hNoHandlers, "Hotspot.RunInteraction: Useinv (none)", eModeUseinv, null, null, "Hotspot.Unhandled.Useinv"); break;
    case 20: TestHotspotInter_Run(hNoHandlers, "Hotspot.RunInteraction: Pickup (none)", eModePickup, null, null, "Hotspot.Unhandled.Pickup"); break;
    case 21: TestHotspotInter_Run(hNoHandlers, "Hotspot.RunInteraction: Pointer (none)", eModePointer, null, null, null); break;
    case 22: TestHotspotInter_Run(hNoHandlers, "Hotspot.RunInteraction: Mode8 (none)", eModeUsermode1, null, null, "Hotspot.Unhandled.Mode8"); break;
    case 23: TestHotspotInter_Run(hNoHandlers, "Hotspot.RunInteraction: Mode9 (none)", eModeUsermode2, null, null, "Hotspot.Unhandled.Mode9"); break;
    }
  }
  else
  {
    TestInter_Check();
  }
}

void TestRegionInteractions(int counter)
{
  bool is_run_case = ((counter % 2) == 0);
  if (is_run_case)
  {
    counter = counter / 2;
    switch (counter)
    {
    case 0: TestRegionEvent_Run(region[1], "Region.RunInteraction: Stands on", 0, "Region.StandOn"); break;
    case 1: TestRegionEvent_Run(region[1], "Region.RunInteraction: Walks onto", 1, "Region.WalkOn"); break;
    case 2: TestRegionEvent_Run(region[1], "Region.RunInteraction: Walks off", 2, "Region.WalkOff"); break;
    }
  }
  else
  {
    TestEvent_Check();
  }
}

int TestInteractions(int counter)
{
  if (counter == 0)
  {
    tap.Comment("start Interactions tests");
  }

  // Each case has 2 counter increments: test run + results check
  int character_test_start = 0;
  int invitem_test_start = CHARACTER_INTERACTION_TEST_CASES * 2;
  int object_test_start = invitem_test_start + INVITEM_INTERACTION_TEST_CASES * 2;
  int hotspot_test_start = object_test_start + OBJECT_INTERACTION_TEST_CASES * 2;
  int region_test_start = hotspot_test_start + HOTSPOT_INTERACTION_TEST_CASES * 2;
  int inter_test_end = region_test_start + REGION_INTERACTION_TEST_CASES * 2;
  
  if (counter < invitem_test_start)
  {
    TestCharacterInteractions(counter);
  }
  else if (counter < object_test_start)
  {
    TestInventoryInteractions(counter - invitem_test_start);
  }
  else if (counter < hotspot_test_start)
  {
    TestObjectInteractions(counter - object_test_start);
  }
  else if (counter < region_test_start)
  {
    TestHotspotInteractions(counter - hotspot_test_start);
  }
  else if (counter < inter_test_end)
  {
    TestRegionInteractions(counter - region_test_start);
  }
  
  counter++;
  if (counter < GetTestInteractionsCount() * 2)
  {
    return counter;
  }
  else
  {
    tap.Comment("end Interactions tests");
    return -1;
  }
}
