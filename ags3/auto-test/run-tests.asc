
int TotalTestCount;

#ifnver 3.6.2
String GetEngineVersionFromRuntimeInfo()
{
  String rt_info = System.RuntimeInfo;
  int ver_at = rt_info.IndexOf("Engine version ");
  if (ver_at >= 0)
  {
    ver_at += 15;
    rt_info = rt_info.Substring(ver_at, rt_info.Length - ver_at);
    int ver_end_at = rt_info.IndexOf("\n");
    if (ver_end_at < 0)
    {
      ver_end_at = rt_info.IndexOf("[");
    }
    if (ver_end_at >= 0)
    {
      rt_info = rt_info.Substring(0, ver_end_at);
    }
    return rt_info;
  }
  return "unknown";
}
#endif

void BeginTests()
{
  int test_count = 0;
  test_count += GetTestMathsCount();
  test_count += GetTestStringCount();
  test_count += GetTestSetCount();
  test_count += GetTestDictionaryCount();
  test_count += GetTestParserCount();
  test_count += GetTestFileCount();
  test_count += GetTestDrawingSurfaceCount();
  test_count += GetTestObjectAccessCount();
  test_count += GetTestGUIPropertiesCount();
  test_count += GetTestMiscCount();
  test_count += GetTestObjectsCount();
  test_count += GetTestCharactersCount();
  test_count += GetTestOverlaysCount();
  test_count += GetTestTimersCount();
  test_count += GetTestInteractionsCount();
  test_count += GetTestPathfindingCount();
  test_count += GetTestEngineRenderCount();
  test_count += GetTestAudioCount();
  
  TotalTestCount = test_count;
  
  tap.clean_test();
#ifver 3.6.2
  tap.Comment(String.Format("Running AGS engine %s", System.GetEngineString(ENGINE_VALUE_S_ENGINE_VERSION_FULL)));
#endif
#ifnver 3.6.2
  tap.Comment(String.Format("Running AGS engine %s", GetEngineVersionFromRuntimeInfo()));
#endif
  tap.plan(test_count);
}

void FinishTests()
{
  tap.done_testing();
  
  if (tap.AnyTestFailed()) {
    AbortGame("ERROR: test(s) have failed.");
  }
  
  if (tap.PlannedTests != tap.ExecutedTests) {
    AbortGame("ERROR: Plan mismatch! Planned %d tests, but ran %d tests.", tap.PlannedTests, tap.ExecutedTests);
  }
  
  QuitGame(0);
}

void RunStage1Tests()
{
  TestString();
  TestMaths();
  TestSet();
  TestDictionary();
  TestParser();
  TestFile();
  TestDrawingSurface();
  TestObjectAccess();
  TestGUIProperties();
  TestMisc();
  TestObjects();
  TestCharacters();
  TestOverlays();
  TestTimers();
  TestEngineRender();
  TestAudio();
}

int RunStage1DelayedTests(int counter)
{
  // Can add more different tests here, depending on "counter" value.
  // Even counter values (0 and onward) are case runs, and odd values are post-case checks.
  // So total counter increments = number of tests * 2.
  counter = TestInteractions(counter);
  return counter;
}

void RunStage2Tests()
{
  TestPathfinding();
}
