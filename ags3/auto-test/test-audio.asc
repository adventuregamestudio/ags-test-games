// Test Audio Module Script
int GetTestAudioCount()
{
  return 0
  + 7 + 8  // play once & repeat
  + 19 * 2 // play on channel
  ;
}

#define AUDIO_CLIP_LENGTH_MS 1000
#define TYPE_1CHAN_FIRST_CHAN 1
#define TYPE_2CHAN_FIRST_CHAN 2
#define TYPE_3CHAN_FIRST_CHAN 4
#define TYPE_FREE_FIRST_CHAN  7

// FIXME: there's a bug in our player impl (related to mojoal), which causes
// position to jump back sometimes. Until it's fixed, keep the related tests
// disabled.
//#define AUDIO_POSITION_BUG_FIXED

void StopAllChannels()
{
  for (int i = 0; i < System.AudioChannelCount; i++)
  {
    System.AudioChannels[i].Stop();
  }
}

// Test that clip plays all its length, and its position changes along.
void TestClipPlayOnce()
{
  StopAllChannels();
  
  AudioChannel* chan = aSilence_1sec_01.Play(eAudioPriorityNormal, eOnce);
  tap.ok(chan != null, "AudioClip.Play(once): valid channel");
  tap.ok(chan.IsPlaying, "AudioClip.Play(once): AudioChannel.IsPlaying");
  tap.ok(!chan.IsPaused, "AudioClip.Play(once): AudioChannel.IsPaused: not paused");
  tap.is_int(chan.PositionMs, 0, "AudioClip.Play(once): AudioChannel.Position: at start");
  tap.is_int(chan.LengthMs, AUDIO_CLIP_LENGTH_MS, "AudioClip.Play(once): AudioChannel.LengthMs");
  
  int last_pos = chan.PositionMs;
  int end_pos = chan.LengthMs;
  bool stay_in_range = true;
  bool forward_progress = true;
  while (chan.IsPlaying)
  {
    int pos = chan.PositionMs;
    //System.Log(eLogAlert, "playback pos ms = %d, last_pos ms = %d", pos, last_pos);
    if (!(pos >= 0 && pos < end_pos))
    {
      stay_in_range = false;
    }
    if (!(pos >= last_pos))
    {
      forward_progress = false;
    }
    last_pos = pos;
    Wait(1);
  }
  
  tap.ok(stay_in_range, "AudioClip.Play(once): AudioChannel.Position: stays in valid range");
#ifdef AUDIO_POSITION_BUG_FIXED
  tap.ok(forward_progress, "AudioClip.Play(once): AudioChannel.Position: advancing");
#endif
  tap.ok(!chan.IsPlaying, "AudioClip.Play(once): AudioChannel.IsPlaying: have stopped");
}

void TestClipPlayRepeat()
{
  StopAllChannels();
  
  AudioChannel* chan = aSilence_1sec_01.Play(eAudioPriorityNormal, eRepeat);
  tap.ok(chan != null, "AudioClip.Play(repeat): valid channel");
  tap.ok(chan.IsPlaying, "AudioClip.Play(repeat): AudioChannel.IsPlaying");
  tap.ok(!chan.IsPaused, "AudioClip.Play(repeat): AudioChannel.IsPaused: not paused");
  tap.is_int(chan.PositionMs, 0, "AudioClip.Play(repeat): AudioChannel.Position: at start");
  tap.is_int(chan.LengthMs, AUDIO_CLIP_LENGTH_MS, "AudioClip.Play(repeat): AudioChannel.LengthMs");
  
  int last_pos = chan.PositionMs;
  int end_pos = chan.LengthMs;
  bool stay_in_range = true;
  bool forward_progress = true;
  bool was_at_end = false;
  int repeat_count = 1;
  int ms_per_tick = 1000 / GetGameSpeed();
  int ms_per_tick_leeway = ms_per_tick * 2;
  int repeat_pos_detection = 100;
  while (chan.IsPlaying)
  {
    int pos = chan.PositionMs;
    //System.Log(eLogAlert, "playback pos ms = %d, last_pos ms = %d", pos, last_pos);
    if (was_at_end && pos < repeat_pos_detection)
    {
      //System.Log(eLogAlert, "REPEAT");
      repeat_count++;
      was_at_end = false;
      if (repeat_count == 3)
      {
        chan.Stop();
        break;
      }
      last_pos = pos;
    }

    if (!(pos >= 0 && pos < end_pos))
    {
      stay_in_range = false;
    }
    if (!(pos >= last_pos))
    {
      forward_progress = false;
    }
    if (pos >= end_pos - ms_per_tick_leeway)
    {
      was_at_end = true;
    }
    last_pos = pos;
    Wait(1);
  }
  
  tap.ok(stay_in_range, "AudioClip.Play(repeat): AudioChannel.Position: stays in valid range");
#ifdef AUDIO_POSITION_BUG_FIXED
  tap.ok(forward_progress, "AudioClip.Play(repeat): AudioChannel.Position: advancing");
#endif
  tap.is_int(repeat_count, 3, "AudioClip.Play(repeat): repeated 3 times");
  tap.ok(!chan.IsPlaying, "AudioClip.Play(repeat): AudioChannel.IsPlaying: have stopped (by command)");
}

void _TestClipOnCorrectChan(AudioClip* clip, String test_name, int expect_chan)
{
  AudioChannel* chan = clip.Play();
  tap.ok(chan != null, String.Format("%s: valid channel", test_name));
  tap.is_int(chan.ID, expect_chan, String.Format("%s: channel ID", test_name));
}

void _TestClipOnDirectChan(AudioClip* clip, String test_name, int expect_chan)
{
  AudioChannel* chan = clip.PlayOnChannel(expect_chan);
  tap.ok(chan != null, String.Format("%s: valid channel", test_name));
  tap.is_int(chan.ID, expect_chan, String.Format("%s: channel ID", test_name));
}

// Test that clip play on correct channels,
// according to the audio type rules.
void TestClipsPlayOnChannels()
{
  StopAllChannels();
  
  // Free chans
  _TestClipOnCorrectChan(aSilence_1sec_01, "AudioClip.Play (Free Chans Type (1))", TYPE_FREE_FIRST_CHAN);
  _TestClipOnCorrectChan(aSilence_1sec_01, "AudioClip.Play (Free Chans Type (2))", TYPE_FREE_FIRST_CHAN + 1);
  _TestClipOnCorrectChan(aSilence_1sec_01, "AudioClip.Play (Free Chans Type (3))", TYPE_FREE_FIRST_CHAN + 2);
  
  // Reserved 1 chan
  _TestClipOnCorrectChan(aSilence_1sec_02, "AudioClip.Play (1 Chan Type (1))", TYPE_1CHAN_FIRST_CHAN);
  _TestClipOnCorrectChan(aSilence_1sec_02, "AudioClip.Play (1 Chan Type (2))", TYPE_1CHAN_FIRST_CHAN);
  
  // Reserved 2 chans
  _TestClipOnCorrectChan(aSilence_1sec_03, "AudioClip.Play (2 Chans Type (1))", TYPE_2CHAN_FIRST_CHAN);
  _TestClipOnCorrectChan(aSilence_1sec_03, "AudioClip.Play (2 Chans Type (2))", TYPE_2CHAN_FIRST_CHAN + 1);
  _TestClipOnCorrectChan(aSilence_1sec_03, "AudioClip.Play (2 Chans Type (3))", TYPE_2CHAN_FIRST_CHAN);
  _TestClipOnCorrectChan(aSilence_1sec_03, "AudioClip.Play (2 Chans Type (4))", TYPE_2CHAN_FIRST_CHAN);
  
  // Reserved 3 chans
  _TestClipOnCorrectChan(aSilence_1sec_04, "AudioClip.Play (3 Chans Type (1))", TYPE_3CHAN_FIRST_CHAN);
  _TestClipOnCorrectChan(aSilence_1sec_04, "AudioClip.Play (3 Chans Type (2))", TYPE_3CHAN_FIRST_CHAN + 1);
  _TestClipOnCorrectChan(aSilence_1sec_04, "AudioClip.Play (3 Chans Type (3))", TYPE_3CHAN_FIRST_CHAN + 2);
  _TestClipOnCorrectChan(aSilence_1sec_04, "AudioClip.Play (3 Chans Type (4))", TYPE_3CHAN_FIRST_CHAN);
  _TestClipOnCorrectChan(aSilence_1sec_04, "AudioClip.Play (3 Chans Type (5))", TYPE_3CHAN_FIRST_CHAN);
  
  // Play on channel direct
  _TestClipOnDirectChan(aSilence_1sec_01, "AudioClip.PlayOnChannel (1)", 1);
  _TestClipOnDirectChan(aSilence_1sec_01, "AudioClip.PlayOnChannel (2)", 2);
  _TestClipOnDirectChan(aSilence_1sec_01, "AudioClip.PlayOnChannel (3)", 3);
  _TestClipOnDirectChan(aSilence_1sec_01, "AudioClip.PlayOnChannel (5)", 5);
  _TestClipOnDirectChan(aSilence_1sec_01, "AudioClip.PlayOnChannel (15)", 15);
}

void TestAudio()
{
  tap.Comment("start Audio tests");
  
  SetGameSpeed(60);
  
  TestClipPlayOnce();
  TestClipPlayRepeat();
  TestClipsPlayOnChannels();
  
  StopAllChannels();
  
  tap.Comment("end Audio tests");
}
