// Test Overlays Module Script

#define CREATION_TEST_COUNT_361 4
#define PROPERTY_TEST_COUNT_361 9
#ifnver 3.6.2
#define PROPERTY_TEST_COUNT_362 0
#endif
#ifnver 3.6.3
#define CREATION_TEST_COUNT_363 0
#define PROPERTY_TEST_COUNT_363 0
#endif
#ifver 3.6.2
#define PROPERTY_TEST_COUNT_362 6
#endif
#ifver 3.6.3
#define CREATION_TEST_COUNT_363 1
#define PROPERTY_TEST_COUNT_363 5
#endif

int GetTestOverlaysCount()
{
  return 0
  + CREATION_TEST_COUNT_361 * 4   // overlay creation tests
  + CREATION_TEST_COUNT_363 * 4
  + PROPERTY_TEST_COUNT_361       // overlay properties
  + PROPERTY_TEST_COUNT_362
  + PROPERTY_TEST_COUNT_363
  + 1       // graphic pos
  ;
}

#define SPRITE_DEFAULT 9

void _TestOverlayCreation(Overlay* over, bool in_room, bool is_graphical, String over_name)
{
  tap.is_int(over.Valid, true, String.Format("Overlay.Create(%s): is valid", over_name));
  if (in_room)
    tap.is_int(over.InRoom, true, String.Format("Overlay.Create(%s): is room overlay", over_name));
    
  else
    tap.is_int(over.InRoom, false, String.Format("Overlay.Create(%s): is screen overlay", over_name));
  tap.is_int(over.Graphic > 0, true, String.Format("Overlay.Create(%s): has graphic", over_name));
  // TODO: this cannot be tested, as textual overlays also generate a sprite and set Graphic property;
  // figure out how to do this test?
  //if (is_graphical)
  //  tap.is_int(over.Graphic > 0, true, String.Format("Overlay.Create(%s): is graphical overlay", over_name));
  //else
  //  tap.is_int(over.Graphic == 0, true, String.Format("Overlay.Create(%s): is non-graphical overlay", over_name));
#ifver 3.6.3
  tap.is_int(over.Visible, true, String.Format("Overlay.Create(%s): is visible", over_name));
#endif
}

void _TestOverlayRemoval(Overlay* over, String over_name)
{
  over.Remove();
  tap.is_int(over.Valid, false, String.Format("Overlay.Remove(%s): is removed", over_name));
}

void _TestOverlayCreationAndRemoval(Overlay* over, bool in_room, bool is_graphical, String over_name)
{
  _TestOverlayCreation(over, in_room, is_graphical, over_name);
  _TestOverlayRemoval(over, over_name);
}

void TestOverlayCreation()
{
  _TestOverlayCreationAndRemoval(Overlay.CreateGraphical(100, 100, SPRITE_DEFAULT), false, true, "graphical screen");
  _TestOverlayCreationAndRemoval(Overlay.CreateRoomGraphical(100, 100, SPRITE_DEFAULT), true, true, "graphical room");
  _TestOverlayCreationAndRemoval(Overlay.CreateTextual(100, 100, 100, eFontFont0, 0, "x"), false, false, "textual screen");
  _TestOverlayCreationAndRemoval(Overlay.CreateRoomTextual(100, 100, 100, eFontFont0, 0, "x"), true, false, "textual room");
}

void TestOverlayProperties(Overlay* over, String over_name)
{
  over.Graphic = 4;
  tap.is_int(over.Graphic, 4, String.Format("%s.Graphic", over_name));
  tap.is_int(over.GraphicHeight, Game.SpriteHeight[4], String.Format("%s.GraphicHeight", over_name));
  tap.is_int(over.GraphicWidth, Game.SpriteWidth[4], String.Format("%s.GraphicWidth", over_name));
  over.Height = 144;
  tap.is_int(over.Height, 144, String.Format("%s.Height", over_name));
  over.Transparency = 50;
  tap.is_int(over.Transparency, 50, String.Format("%s.Transparency", over_name));
#ifver 3.6.3
  over.Visible = false;
  tap.is_int(over.Visible, false, String.Format("%s.Visible", over_name));
#endif
  over.Width = 156;
  tap.is_int(over.Width, 156, String.Format("%s.Width", over_name));
  over.X = 77;
  tap.is_int(over.X, 77, String.Format("%s.X", over_name));
  over.Y = 99;
  tap.is_int(over.Y, 99, String.Format("%s.Y", over_name));
  over.ZOrder = 111;
  tap.is_int(over.ZOrder, 111, String.Format("%s.ZOrder", over_name));
  
#ifver 3.6.2
  // Functions
  over.SetPosition(1, 2, 40, 50);
  tap.is_int(over.X, 1, String.Format("%s.SetPosition(): x", over_name));
  tap.is_int(over.Y, 2, String.Format("%s.SetPosition(): y", over_name));
  tap.is_int(over.Width, 40, String.Format("%s.SetPosition(): width", over_name));
  tap.is_int(over.Height, 50, String.Format("%s.SetPosition(): height", over_name));
  
  over.SetSize(60, 70);
  tap.is_int(over.Width, 60, String.Format("%s.SetSize(): width", over_name));
  tap.is_int(over.Height, 70, String.Format("%s.SetSize(): height", over_name));
#endif
#ifver 3.6.3
  tap.is(over.Text, "", String.Format("%s.Text: initial", over_name));
  over.Text = "custom";
  tap.is(over.Text, "custom", String.Format("%s.Text: set", over_name));
#endif
}

void TestTextOverlayProperties(Overlay* over, String createdWithText, String over_name)
{
#ifver 3.6.3
  tap.is(over.Text, createdWithText, String.Format("%s.Text: initial", over_name));
  over.Text = "custom";
  tap.is(over.Text, "custom", String.Format("%s.Text: set", over_name));
#endif
}

//int test_render_num;
void _TestObjectRenderF(Overlay *testObject, int sprite_num, eFlipDirection flip, String test_name)
{
  Wait(1); // let engine redraw
  int sprite_w = Game.SpriteWidth[sprite_num];
  int sprite_h = Game.SpriteHeight[sprite_num];
  int sprite_x = testObject.X;
  int sprite_y = testObject.Y;
  //tap.Comment(String.Format("sprite_x = %d, sprite_y = %d, sprite_w = %d, sprite_h = %d", sprite_x, sprite_y, sprite_w, sprite_h));
  //SaveScreenShot(String.Format("_overlay_%d.bmp", test_render_num));
  //test_render_num++;
  tap.ok(GfxComparer.TakeScreenshotAndMatchSprite(sprite_x, sprite_y, sprite_w, sprite_h, sprite_num, flip), test_name);
}

void _TestObjectRender(Overlay *testObject, int sprite_num, String test_name)
{
  _TestObjectRenderF(testObject, sprite_num, -1, test_name);
}

void TestGraphicPosition(Overlay *testObject, String overlay_name)
{
  testObject.Graphic = SPRITE_DEFAULT;
  _TestObjectRender(testObject, SPRITE_DEFAULT, String.Format("%s: graphic position", overlay_name));
}

void TestOverlays()
{
  tap.Comment("start Overlays tests");
  tap.Comment(String.Format("System.HardwareAcceleration = %d", System.HardwareAcceleration));
  
  // Disable characters and objects, avoid interfering with our tests
  TestHelpers.HideRoomObjects();
  
  //------------------------------------------------------------
  // Basic Overlays
  //------------------------------------------------------------
  // Test overlay creation
  TestOverlayCreation();
  
  Overlay* over = Overlay.CreateGraphical(100, 100, 0);
  // Test properties
  TestOverlayProperties(over, "Overlay");
  over = Overlay.CreateTextual(100, 100, 100, eFontFont0, 12345, "some string to display");
  TestTextOverlayProperties(over, "some string to display", "TextualOverlay");
  // Test rendering
  over = Overlay.CreateGraphical(100, 100, 0);
  TestGraphicPosition(over, "Overlay");
  over.Remove();
  
  tap.Comment("end Overlays tests");
}
